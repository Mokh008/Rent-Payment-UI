<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª</title>

<style>
:root{
  --bg:#F1F5F9;
  --text:#020617;
  --border:#CBD5E1;
  --dark:#020617;
  --success:#16A34A;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  min-height:100vh;
  background:var(--bg);
  font-family:"Segoe UI",Tahoma,sans-serif;
  color:var(--text);
  display:flex;
  justify-content:center;
  padding:30px 15px;
}

.container{
  width:100%;
  max-width:1100px;
}

.page-title{
  text-align:center;
  font-size:28px;
  font-weight:800;
  margin-bottom:20px;
}

/* ===== Card ===== */
.main-card{
  background:#fff;
  border-radius:18px;
  padding:22px;
  box-shadow:0 12px 25px rgba(0,0,0,.08);
  text-align:center;
  max-width:420px;
  margin:0 auto 25px;
}

.main-card input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:15px;
}

.main-btn{
  margin-top:15px;
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  background:var(--dark);
  color:#fff;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
}

/* ===== Table ===== */
.table-wrapper{
  background:#020617;
  border-radius:18px;
  padding:20px;
  color:#E5E7EB;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th,td{
  padding:12px;
  text-align:center;
}

th{
  color:#93C5FD;
  border-bottom:1px solid #1E293B;
}

tr{
  border-bottom:1px solid #1E293B;
}

select{
  padding:6px;
  border-radius:8px;
}

/* ===== Buttons ===== */
.pay-btn{
  padding:6px 12px;
  border-radius:8px;
  border:none;
  background:#2563EB;
  color:#fff;
  cursor:pointer;
}

.paid{
  background:var(--success)!important;
  cursor:default;
}

.print-btn{
  margin-top:20px;
  padding:16px;
  width:100%;
  border:none;
  border-radius:14px;
  background:#111827;
  color:#fff;
  font-size:18px;
  font-weight:800;
  cursor:pointer;
}

/* ===== Warnings ===== */
.warn-60{
  background:rgba(249,115,22,.15);
  color:#FED7AA;
}
.warn-30{
  background:rgba(234,179,8,.15);
  color:#FEF08A;
}

.badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
  margin-inline-start:6px;
}
.badge-60{ background:#F97316; color:#111827; }
.badge-30{ background:#EAB308; color:#111827; }

.notice{
  font-size:12px;
  opacity:.9;
  margin-top:6px;
}

/* ===== Loading ===== */
.loading-overlay{
  position:fixed;
  inset:0;
  background:rgba(2,6,23,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.loading-box{
  background:#020617;
  padding:30px 40px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 20px 50px rgba(0,0,0,.4);
}

.spinner{
  width:48px;
  height:48px;
  border:4px solid #1E293B;
  border-top:4px solid #38BDF8;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto 15px;
}

@keyframes spin{ to{ transform:rotate(360deg); } }

.loading-text{
  color:#E5E7EB;
  font-size:15px;
  font-weight:600;
}
</style>
</head>

<body>

<div class="container">
  <div class="page-title">Ù†Ø¸Ø§Ù… Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª</div>

  <div class="main-card">
    <input id="engineerId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³">
    <button class="main-btn" onclick="loadData()">Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  </div>

  <div id="result"></div>
</div>

<!-- Loading -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-box">
    <div class="spinner"></div>
    <div id="loadingText" class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz1J46xbhrp_1AT5y7Tws8oc3iTkhZTYodbo1gDekk0U4_MePlv1zWn05VmuaJIo866UA/exec";
let printedReceipts = [];

/* ===== Loading ===== */
function showLoading(text){
  document.getElementById("loadingText").innerText = text || "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  document.getElementById("loadingOverlay").style.display = "flex";
}
function hideLoading(){
  document.getElementById("loadingOverlay").style.display = "none";
}

/* ===== Warnings ===== */
function getWarning(days){
  if(days <= 30){
    return {
      rowClass:"warn-30",
      badge:'<span class="badge badge-30">Ù‚Ø±ÙŠØ¨</span>',
      text:"Ø§Ù„Ø¹Ù‚Ø¯ Ù‡ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…"
    };
  }
  if(days <= 60){
    return {
      rowClass:"warn-60",
      badge:'<span class="badge badge-60">ØªÙ†Ø¨ÙŠÙ‡</span>',
      text:"Ø§Ù„Ø¹Ù‚Ø¯ Ù‡ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ 60 ÙŠÙˆÙ…"
    };
  }
  return { rowClass:"", badge:"", text:"" };
}

/* ===== Load Data ===== */
function loadData(){
  const id=document.getElementById("engineerId").value.trim();
  if(!id) return;

  showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§ØªØ¨...");

  fetch(API_URL+"?action=getAssets&engineerId="+id)
    .then(r=>r.json())
    .then(data=>{
      hideLoading();
      showData(data);
    })
    .catch(()=>{
      hideLoading();
      alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
    });
}

/* ===== Show Data ===== */
function showData(data){
  if(!data.length){
    document.getElementById("result").innerHTML="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª";
    return;
  }

  let html=`
  <div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Ø§Ù„Ù…ÙƒØªØ¨</th>
        <th>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</th>
        <th>Ø§Ù„Ø´Ù‡Ø±</th>
        <th>Ø§Ù„Ø¯ÙØ¹</th>
      </tr>
    </thead><tbody>`;

  data.forEach((item,i)=>{
    const warn = getWarning(item.remainingDays);

    html+=`
    <tr class="${warn.rowClass}">
      <td>
        ${item.assetName}
        ${warn.badge}
        ${warn.text ? `<div class="notice">${warn.text}</div>` : ``}
      </td>
      <td>${item.monthlyRent}</td>
      <td>
        <select id="month_${i}">
          <option value="">Ø§Ø®ØªØ±</option>
          <option>12-2025</option>
          <option>01-2026</option>
          <option>02-2026</option>
        </select>
      </td>
      <td>
        <button class="pay-btn" id="pay_${i}"
        onclick="pay(${i},'${item.assetName}','${item.ownerName}','${item.ownerNationalId}',${item.monthlyRent})">
        Ø¯ÙØ¹
        </button>
      </td>
    </tr>`;
  });

  html+=`</tbody></table>
    <button class="print-btn" onclick="printAll()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</button>
  </div>`;

  document.getElementById("result").innerHTML=html;
}

/* ===== Pay ===== */
function pay(i,asset,owner,nid,amount){
  const month=document.getElementById("month_"+i).value;
  if(!month) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±");

  showLoading("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹...");

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"confirmPayment",
      engineerId:document.getElementById("engineerId").value,
      assetName:asset,
      ownerName:owner,
      ownerNationalId:nid,
      amount:amount,
      month:month
    })
  })
  .then(r=>r.json())
  .then(res=>{
    hideLoading();
    if(res.error){ alert(res.error); return; }

    const btn=document.getElementById("pay_"+i);
    btn.innerText="âœ” ØªÙ… Ø§Ù„Ø¯ÙØ¹";
    btn.classList.add("paid");
    btn.disabled=true;

    printedReceipts.push(res.pdfUrl);
  })
  .catch(()=>{
    hideLoading();
    alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„");
  });
}

/* ===== Print ===== */
function printAll(){
  if(!printedReceipts.length){
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØµØ§Ù„Ø§Øª");
    return;
  }

  showLoading("Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª...");
  setTimeout(()=>{
    printedReceipts.forEach(u=>window.open(u));
    hideLoading();
  },800);
}
</script>

</body>
</html>
