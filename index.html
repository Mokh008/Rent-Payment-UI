<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>نظام دفع الإيجارات</title>

<style>
:root{
  --bg:#F1F5F9;
  --text:#020617;
  --border:#CBD5E1;
  --dark:#020617;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  min-height:100vh;
  background:var(--bg);
  font-family:"Segoe UI",Tahoma,sans-serif;
  color:var(--text);
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:30px 15px;
}

.container{
  width:100%;
  max-width:1100px;
}

.page-title{
  text-align:center;
  font-size:28px;
  font-weight:800;
  margin-bottom:20px;
}

.main-card{
  background:#fff;
  border-radius:18px;
  padding:22px 20px;
  box-shadow:0 12px 25px rgba(0,0,0,.08);
  text-align:center;
  margin-bottom:25px;
  max-width:420px;
  margin-left:auto;
  margin-right:auto;
}

.main-card label{
  display:block;
  text-align:right;
  font-weight:600;
  margin-bottom:6px;
}

.main-card input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:15px;
}

.main-btn{
  margin-top:15px;
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  background:var(--dark);
  color:#fff;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
}

.loader{
  width:36px;
  height:36px;
  border:4px solid #E5E7EB;
  border-top:4px solid #020617;
  border-radius:50%;
  margin:20px auto;
  animation:spin 1s linear infinite;
  display:none;
}
@keyframes spin{ to{ transform:rotate(360deg);} }

.table-wrapper{
  background:#020617;
  border-radius:18px;
  padding:20px;
  color:#E5E7EB;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th,td{
  padding:12px;
  text-align:center;
}

th{
  color:#93C5FD;
  border-bottom:1px solid #1E293B;
}

tr{
  border-bottom:1px solid #1E293B;
}

.owner{
  color:#FDE68A;
  font-weight:600;
}

select{
  padding:6px 8px;
  border-radius:8px;
}

.pay-btn{
  padding:6px 12px;
  border-radius:8px;
  border:none;
  background:#2563EB;
  color:#fff;
  font-size:13px;
  cursor:pointer;
}
.pay-btn.paid{
  background:#16A34A;
  cursor:default;
}

.print-btn{
  margin-bottom:15px;
  padding:10px 16px;
  border-radius:10px;
  border:none;
  background:#0F766E;
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="container">
  <div class="page-title">نظام دفع الإيجارات</div>

  <div class="main-card">
    <label>رقم المهندس (ID)</label>
    <input id="engineerId" type="text" placeholder="مثال: 1001777">
    <button class="main-btn" onclick="loadData()">عرض البيانات</button>
    <div id="loading" class="loader"></div>
  </div>

  <div id="result"></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxtfbjlH-eYsFw-NBCclYV2FlJ7adUOCz4ckZMy009MrwcTjoqu2LWrpPn55c9v97tb4g/exec";

function formatDate(d){
  return d ? new Date(d).toLocaleDateString("ar-EG") : "-";
}

function loadData(){
  const id=document.getElementById("engineerId").value.trim();
  if(!id){ alert("أدخل رقم المهندس"); return; }

  document.getElementById("loading").style.display="block";

  fetch(API_URL+"?action=getAssets&engineerId="+id)
    .then(r=>r.json())
    .then(d=>{
      document.getElementById("loading").style.display="none";
      showData(d);
    });
}

function showData(data){
  let html = `
  <button class="print-btn" onclick="printReceipts()">طباعة الإيصالات</button>
  <div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>المكتب</th>
        <th>الموقع</th>
        <th>النوع</th>
        <th>الإيجار</th>
        <th>بداية</th>
        <th>نهاية</th>
        <th>المتبقي</th>
        <th>المالك</th>
        <th>الشهر</th>
        <th>الدفع</th>
      </tr>
    </thead>
    <tbody>
  `;

  data.forEach(i=>{
    const k=i.assetName.replace(/\s/g,"_");
    html+=`
    <tr>
      <td>${i.assetName}</td>
      <td>${i.location}</td>
      <td>${i.assetType}</td>
      <td>${i.monthlyRent}</td>
      <td>${formatDate(i.contractStart)}</td>
      <td>${formatDate(i.contractEnd)}</td>
      <td>${i.remainingDays}</td>
      <td class="owner">${i.ownerName}</td>
      <td>
        <select id="m_${k}">
          <option value="">اختر</option>
          <option>12-2025</option>
          <option>01-2026</option>
          <option>02-2026</option>
        </select>
      </td>
      <td>
        <button class="pay-btn" onclick='payNow(this,${JSON.stringify(i)})'>دفع</button>
      </td>
    </tr>`;
  });

  html+=`</tbody></table></div>`;
  document.getElementById("result").innerHTML=html;
}

function payNow(btn,item){
  const month=document.getElementById(
    "m_"+item.assetName.replace(/\s/g,"_")
  ).value;

  if(!month){ alert("اختر الشهر"); return; }

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"confirmPayment",
      engineerId:document.getElementById("engineerId").value,
      assetName:item.assetName,
      month:month
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.error){
      alert(res.error);
      return;
    }
    btn.innerText="تم الدفع";
    btn.classList.add("paid");
    btn.disabled=true;
  });
}

function printReceipts(){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"printBatch",
      engineerId:document.getElementById("engineerId").value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.pdfUrl){
      window.open(res.pdfUrl);
    }else{
      alert("لا توجد إيصالات للطباعة");
    }
  });
}
</script>

</body>
</html>
