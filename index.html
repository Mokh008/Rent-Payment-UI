<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>نظام الإيجارات</title>

<style>
:root{
  --bg:#F1F5F9;
  --text:#020617;
  --border:#CBD5E1;
  --dark:#020617;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  min-height:100vh;
  background:var(--bg);
  font-family:"Segoe UI",Tahoma,sans-serif;
  color:var(--text);
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:40px 15px;
}

.container{
  width:100%;
  max-width:1100px;
}

/* ===== Main Card ===== */
.main-card{
  background:#fff;
  border-radius:22px;
  padding:40px 35px;
  box-shadow:0 20px 40px rgba(0,0,0,.08);
  text-align:center;
  margin-bottom:30px;
}

.main-card h1{
  margin:0 0 25px;
  font-size:34px;
  font-weight:800;
}

.field{
  text-align:right;
  margin-bottom:22px;
}

.field label{
  display:block;
  margin-bottom:8px;
  font-weight:600;
}

input{
  width:100%;
  padding:16px 18px;
  border-radius:14px;
  border:1px solid var(--border);
  font-size:16px;
  outline:none;
}

.main-btn{
  margin-top:25px;
  width:100%;
  padding:18px;
  border-radius:16px;
  border:none;
  background:var(--dark);
  color:#fff;
  font-size:18px;
  font-weight:700;
  cursor:pointer;
}

#error{
  margin-top:15px;
  color:#DC2626;
  font-size:14px;
}

/* ===== Table ===== */
.table-wrapper{
  background:#020617;
  border-radius:18px;
  padding:20px;
  color:#E5E7EB;
  box-shadow:0 20px 40px rgba(0,0,0,.2);
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th,td{
  padding:12px;
  text-align:center;
}

th{
  color:#93C5FD;
  border-bottom:1px solid #1E293B;
}

tr{
  border-bottom:1px solid #1E293B;
}

tr:hover{
  background:#020617;
}

select{
  padding:6px 8px;
  border-radius:8px;
}

.pay-btn{
  padding:6px 12px;
  border-radius:8px;
  border:none;
  background:#2563EB;
  color:#fff;
  font-size:13px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="container">

  <!-- ===== Card ===== -->
  <div class="main-card">
    <h1>عرض المكاتب والاستراحات</h1>

    <div class="field">
      <label>رقم المهندس (ID)</label>
      <input id="engineerId" type="text" placeholder="مثال: 1001777">
    </div>

    <button class="main-btn" onclick="loadData()">عرض البيانات</button>
    <div id="error"></div>
  </div>

  <!-- ===== Result ===== -->
  <div id="result"></div>

</div>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbwn9TRekl7HRtGtC_cI8ypyHzp8L2y2aQntNQF0KOpS3DeS7nneCRK42FX1eMcOWCZzzQ/exec";

function formatDate(d){
  if(!d) return "-";
  return new Date(d).toLocaleDateString("ar-EG");
}

function loadData(){
  const id=document.getElementById("engineerId").value.trim();
  const error=document.getElementById("error");
  const result=document.getElementById("result");

  error.innerText="";
  result.innerHTML="";

  if(!id){
    error.innerText="من فضلك أدخل رقم المهندس";
    return;
  }

  fetch(API_URL+"?action=getAssets&engineerId="+id)
    .then(res=>res.json())
    .then(showData)
    .catch(()=>{
      error.innerText="خطأ في الاتصال بالسيرفر";
    });
}

function showData(data){
  const result=document.getElementById("result");

  if(!data || data.length===0){
    result.innerHTML="<p style='text-align:center'>لا توجد بيانات</p>";
    return;
  }

  let html=`
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>المكتب</th>
          <th>الموقع</th>
          <th>النوع</th>
          <th>الإيجار</th>
          <th>بداية العقد</th>
          <th>نهاية العقد</th>
          <th>الأيام المتبقية</th>
          <th>الشهر</th>
          <th>الدفع</th>
        </tr>
      </thead>
      <tbody>
  `;

  data.forEach(item=>{
    const key = item.assetName.replace(/\s/g,"_");
    html+=`
      <tr>
        <td>${item.assetName}</td>
        <td>${item.location}</td>
        <td>${item.assetType}</td>
        <td>${item.monthlyRent}</td>
        <td>${formatDate(item.contractStart)}</td>
        <td>${formatDate(item.contractEnd)}</td>
        <td>${item.remainingDays}</td>
        <td>
          <select id="m_${key}">
            <option value="">اختر الشهر</option>
            <option>12-2025</option>
            <option>01-2026</option>
            <option>02-2026</option>
          </select>
        </td>
        <td>
          <button class="pay-btn"
            onclick="confirmPayment(
              '${item.assetName}',
              '${item.monthlyRent}',
              '${item.ownerName}',
              '${item.ownerNationalId}'
            )">
            Confirm
          </button>
        </td>
      </tr>
    `;
  });

  html+=`</tbody></table></div>`;
  result.innerHTML=html;
}

function confirmPayment(assetName, amount, ownerName, ownerNationalId){
  const key = assetName.replace(/\s/g,"_");
  const month = document.getElementById("m_"+key).value;

  if(!month){
    alert("من فضلك اختر الشهر أولاً");
    return;
  }

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"confirmPayment",
      engineerId:document.getElementById("engineerId").value,
      assetName,
      month,
      amount,
      ownerName,
      ownerNationalId
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.error){
      alert(res.error);
    }else{
      window.open(res.pdfUrl,"_blank");
      alert("تم الدفع وتوليد الإيصال");
    }
  });
}
</script>

</body>
</html>
