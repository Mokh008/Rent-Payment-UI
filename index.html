<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª</title>

<style>
:root{
  --bg:#F1F5F9;
  --text:#020617;
  --border:#CBD5E1;
  --dark:#020617;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  min-height:100vh;
  background:var(--bg);
  font-family:"Segoe UI",Tahoma,sans-serif;
  color:var(--text);
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:30px 15px;
}

.container{
  width:100%;
  max-width:1100px;
}

.page-title{
  text-align:center;
  font-size:28px;
  font-weight:800;
  margin-bottom:20px;
}

.main-card{
  background:#fff;
  border-radius:18px;
  padding:22px 20px;
  box-shadow:0 12px 25px rgba(0,0,0,.08);
  text-align:center;
  margin-bottom:25px;
  max-width:420px;
  margin-left:auto;
  margin-right:auto;
}

.main-card label{
  display:block;
  text-align:right;
  font-weight:600;
  margin-bottom:6px;
}

.main-card input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:15px;
}

.main-btn{
  margin-top:15px;
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  background:var(--dark);
  color:#fff;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
}

/* Loader */
.global-loader{
  position:fixed;
  inset:0;
  background:rgba(2,6,23,.55);
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:9999;
}
.spinner{
  width:48px;
  height:48px;
  border:5px solid #CBD5E1;
  border-top:5px solid #38BDF8;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
.loader-text{
  margin-top:12px;
  color:#fff;
  font-weight:700;
}
@keyframes spin{ to{ transform:rotate(360deg);} }

/* Table */
.table-wrapper{
  background:#020617;
  border-radius:18px;
  padding:20px;
  color:#E5E7EB;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th,td{
  padding:12px;
  text-align:center;
}

th{
  color:#93C5FD;
  border-bottom:1px solid #1E293B;
}

tr{
  border-bottom:1px solid #1E293B;
}

.owner{
  color:#FDE68A;
  font-weight:600;
}

select{
  padding:6px 8px;
  border-radius:8px;
}

.pay-btn{
  padding:6px 12px;
  border-radius:8px;
  border:none;
  background:#2563EB;
  color:#fff;
  font-size:13px;
  cursor:pointer;
}
.pay-btn.paid{
  background:#16A34A;
  cursor:default;
}

.print-btn{
  margin-bottom:15px;
  padding:10px 16px;
  border-radius:10px;
  border:none;
  background:#0F766E;
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="globalLoader" class="global-loader">
  <div class="spinner"></div>
  <div class="loader-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...</div>
</div>

<div class="container">

  <div class="page-title">Ù†Ø¸Ø§Ù… Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª</div>

  <div class="main-card">
    <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ (ID)</label>
    <input id="engineerId" type="text" placeholder="Ù…Ø«Ø§Ù„: 1001777">
    <button class="main-btn" onclick="loadData()">Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  </div>

  <div id="result"></div>

</div>

<script>
/* ğŸ”´ Ù„ÙŠÙ†Ùƒ Ø§Ù„Ù€ Web App */
const API_URL = "https://script.google.com/macros/s/AKfycby_eXcxmrXVKqNSlU2x82LJw8GXI781xjnrdf34lbflRXyHqn7t2voHBlrtunxQUT5f5Q/exec";

/* âœ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø´Ù‡ÙˆØ± Ø§Ù„Ù„ÙŠ Ø§ØªØ¯ÙØ¹Øª */
let paidMonths = new Set();

/* âœ… Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ù‡ÙˆØ± (Ø¯ÙŠØ³Ù…Ø¨Ø± 2025 + ÙƒÙ„ 2026) */
function generateMonths(startYear, startMonth, count) {
  const months = [];
  let y = startYear;
  let m = startMonth;

  for (let i = 0; i < count; i++) {
    months.push(String(m).padStart(2,"0") + "-" + y);
    m++;
    if (m > 12) {
      m = 1;
      y++;
    }
  }
  return months;
}

/* âœ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø´Ù‡Ø± Ù„Ø±Ù‚Ù… Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© */
function monthToNumber(m){
  const [mm, yy] = m.split("-");
  return (parseInt(yy) * 12) + parseInt(mm);
}

function showLoader(text){
  document.querySelector(".loader-text").innerText = text || "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...";
  document.getElementById("globalLoader").style.display="flex";
}
function hideLoader(){
  document.getElementById("globalLoader").style.display="none";
}

function formatDate(d){
  return d ? new Date(d).toLocaleDateString("ar-EG") : "-";
}

/* Load Assets */
function loadData(){
  const id = document.getElementById("engineerId").value.trim();
  if(!id){ alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³"); return; }

  paidMonths.clear();
  showLoader("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");

  fetch(API_URL+"?action=getAssets&engineerId="+id)
    .then(r=>r.json())
    .then(d=>{
      hideLoader();
      renderTable(d);
    })
    .catch(()=>{
      hideLoader();
      alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
    });
}

/* Render Table */
function renderTable(data){

  if(!data || !data.length){
    document.getElementById("result").innerHTML =
      "<p style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>";
    return;
  }

  const monthsList = generateMonths(2025, 12, 13);

  let html = `
  <button class="print-btn" onclick="printReceipts()">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</button>
  <div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Ø§Ù„Ù…ÙƒØªØ¨</th>
        <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
        <th>Ø§Ù„Ù†ÙˆØ¹</th>
        <th>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</th>
        <th>Ø¨Ø¯Ø§ÙŠØ©</th>
        <th>Ù†Ù‡Ø§ÙŠØ©</th>
        <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
        <th>Ø§Ù„Ù…Ø§Ù„Ùƒ</th>
        <th>Ø§Ù„Ø´Ù‡Ø±</th>
        <th>Ø§Ù„Ø¯ÙØ¹</th>
      </tr>
    </thead>
    <tbody>`;

  data.forEach(i=>{
    const key = i.assetName.replace(/\s/g,"_");
    html += `
    <tr>
      <td>${i.assetName}</td>
      <td>${i.location}</td>
      <td>${i.assetType}</td>
      <td>${i.monthlyRent}</td>
      <td>${formatDate(i.contractStart)}</td>
      <td>${formatDate(i.contractEnd)}</td>
      <td>${i.remainingDays}</td>
      <td class="owner">${i.ownerName}</td>
      <td>
        <select id="m_${key}">
          <option value="">Ø§Ø®ØªØ±</option>
          ${monthsList.map(m=>`<option value="${m}">${m}</option>`).join("")}
        </select>
      </td>
      <td>
        <button class="pay-btn" onclick='payNow(this,${JSON.stringify(i)})'>Ø¯ÙØ¹</button>
      </td>
    </tr>`;
  });

  html += "</tbody></table></div>";
  document.getElementById("result").innerHTML = html;
}

/* Confirm Payment */
function payNow(btn,item){

  const month = document.getElementById(
    "m_"+item.assetName.replace(/\s/g,"_")
  ).value;

  if(!month){
    alert("Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±");
    return;
  }

  /* âœ… Ù…Ù†Ø¹ Ø§Ù„Ø¯ÙØ¹ Ø¨Ø¹Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ */
  const selectedMonthNum = monthToNumber(month);
  const endDate = new Date(item.contractEnd);
  const contractEndMonth = (endDate.getFullYear() * 12) + (endDate.getMonth() + 1);

  if(selectedMonthNum > contractEndMonth){
    alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¯ÙØ¹ Ø¨Ø¹Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯");
    return;
  }

  btn.disabled = true;
  showLoader("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹...");

  fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({
      action: "confirmPayment",
      engineerId: document.getElementById("engineerId").value,
      assetName: item.assetName,
      month: month
    })
  })
  .then(r=>r.json())
  .then(res=>{
    hideLoader();

    if(res.error){
      btn.disabled=false;
      alert(res.error);
      return;
    }

    btn.innerText="ØªÙ… Ø§Ù„Ø¯ÙØ¹";
    btn.classList.add("paid");
    paidMonths.add(month);
  })
  .catch(()=>{
    hideLoader();
    btn.disabled=false;
    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹");
  });
}

/* Print Receipts */
function printReceipts(){

  const engineerId = document.getElementById("engineerId").value.trim();
  if(!engineerId){
    alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³");
    return;
  }

  if(paidMonths.size === 0){
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØµØ§Ù„Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©");
    return;
  }

  const month = Array.from(paidMonths)[0];

  showLoader("Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª...");

  fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({
      action: "printReceipts",
      engineerId: engineerId,
      month: month
    })
  })
  .then(r=>r.json())
  .then(res=>{
    hideLoader();

    if(res.error){
      alert(res.error);
      return;
    }

    if(res.pdfUrl){
      window.location.href = res.pdfUrl;
    }else{
      alert("Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª");
    }
  })
  .catch(()=>{
    hideLoader();
    alert("ØªØ¹Ø°Ø± ÙØªØ­ Ù…Ù„Ù Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª");
  });
}
</script>

</body>
</html>
